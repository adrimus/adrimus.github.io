<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>üõ†Ô∏è Automating Sophos Uninstall Across Hundreds of PCs‚ÄîWithout Disrupting Users | Adrian Muscat</title>
<meta name="keywords" content="">
<meta name="description" content="Migrating from Sophos to Defender for Endpoint came with a major challenge: tamper protection. To tackle it, I built a PowerShell module that interacts with the Sophos Central API to disable tamper protection remotely. You can check it out on GitHub.
TL;DR
This setup saved countless hours, avoided manual intervention, and kept users blissfully unaware‚Äîjust the way it should be. If you‚Äôre facing a similar migration, feel free to explore or fork the modules, I didn&rsquo;t get a chance to finish the module and did not include all the necessary components like paging as I didn&rsquo;t have to deal with more than 200 endpoints. Always happy to connect with others tackling endpoint automation!">
<meta name="author" content="">
<link rel="canonical" href="https://adrianmuscat.com/projects/endpoint-uninstall-automation/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6da9a63d25a9608bca2f7f907a030e887a7dd3c3f3918e4cc113129361414bda.css" integrity="sha256-bammPSWpYIvKL3&#43;QegMOiHp908PzkY5MwRMSk2FBS9o=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://adrianmuscat.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://adrianmuscat.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://adrianmuscat.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://adrianmuscat.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://adrianmuscat.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://adrianmuscat.com/projects/endpoint-uninstall-automation/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://adrianmuscat.com/projects/endpoint-uninstall-automation/">
  <meta property="og:site_name" content="Adrian Muscat">
  <meta property="og:title" content="üõ†Ô∏è Automating Sophos Uninstall Across Hundreds of PCs‚ÄîWithout Disrupting Users">
  <meta property="og:description" content="Migrating from Sophos to Defender for Endpoint came with a major challenge: tamper protection. To tackle it, I built a PowerShell module that interacts with the Sophos Central API to disable tamper protection remotely. You can check it out on GitHub.
TL;DR This setup saved countless hours, avoided manual intervention, and kept users blissfully unaware‚Äîjust the way it should be. If you‚Äôre facing a similar migration, feel free to explore or fork the modules, I didn‚Äôt get a chance to finish the module and did not include all the necessary components like paging as I didn‚Äôt have to deal with more than 200 endpoints. Always happy to connect with others tackling endpoint automation!">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:published_time" content="2025-05-17T07:18:22+02:00">
    <meta property="article:modified_time" content="2025-05-17T07:18:22+02:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="üõ†Ô∏è Automating Sophos Uninstall Across Hundreds of PCs‚ÄîWithout Disrupting Users">
<meta name="twitter:description" content="Migrating from Sophos to Defender for Endpoint came with a major challenge: tamper protection. To tackle it, I built a PowerShell module that interacts with the Sophos Central API to disable tamper protection remotely. You can check it out on GitHub.
TL;DR
This setup saved countless hours, avoided manual intervention, and kept users blissfully unaware‚Äîjust the way it should be. If you‚Äôre facing a similar migration, feel free to explore or fork the modules, I didn&rsquo;t get a chance to finish the module and did not include all the necessary components like paging as I didn&rsquo;t have to deal with more than 200 endpoints. Always happy to connect with others tackling endpoint automation!">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Projects",
      "item": "https://adrianmuscat.com/projects/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "üõ†Ô∏è Automating Sophos Uninstall Across Hundreds of PCs‚ÄîWithout Disrupting Users",
      "item": "https://adrianmuscat.com/projects/endpoint-uninstall-automation/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "üõ†Ô∏è Automating Sophos Uninstall Across Hundreds of PCs‚ÄîWithout Disrupting Users",
  "name": "üõ†Ô∏è Automating Sophos Uninstall Across Hundreds of PCs‚ÄîWithout Disrupting Users",
  "description": "Migrating from Sophos to Defender for Endpoint came with a major challenge: tamper protection. To tackle it, I built a PowerShell module that interacts with the Sophos Central API to disable tamper protection remotely. You can check it out on GitHub.\nTL;DR This setup saved countless hours, avoided manual intervention, and kept users blissfully unaware‚Äîjust the way it should be. If you‚Äôre facing a similar migration, feel free to explore or fork the modules, I didn\u0026rsquo;t get a chance to finish the module and did not include all the necessary components like paging as I didn\u0026rsquo;t have to deal with more than 200 endpoints. Always happy to connect with others tackling endpoint automation!\n",
  "keywords": [
    
  ],
  "articleBody": "Migrating from Sophos to Defender for Endpoint came with a major challenge: tamper protection. To tackle it, I built a PowerShell module that interacts with the Sophos Central API to disable tamper protection remotely. You can check it out on GitHub.\nTL;DR This setup saved countless hours, avoided manual intervention, and kept users blissfully unaware‚Äîjust the way it should be. If you‚Äôre facing a similar migration, feel free to explore or fork the modules, I didn‚Äôt get a chance to finish the module and did not include all the necessary components like paging as I didn‚Äôt have to deal with more than 200 endpoints. Always happy to connect with others tackling endpoint automation!\nüîß ‚ÄúThe Orchestrator: Control Script‚Äù Then I created a control script that:\nüîì Disables tamper protection via the API üßπ Runs the uninstall script on the target PC üìÅ Logs results to a file so each PC is only processed once üïí Runs after hours and checks that no user is signed in‚Äîensuring zero disruption Start-Transcript -Path c:\\transcript.txt param ( # Array of servers to connect to $servers = 'C:\\POWERSHELL2\\MDM\\server.txt', # Specifies the path to save the results. If the script is interrupted and rerun, it will skip servers that have already been processed. $CsvFile = '~\\Results.csv', # The script file which is executed remotely on computer $ScriptFile = '.\\Uninstall-Sohpos.ps1', # Another CSV file to record connection errors $ConnectionErrors = '~\\Errors.csv' ) Import-Module PSSophosCentral -Force #region API credentials # Get password for vault $passwordPath = Join-Path (Split-Path $profile) SecretStore.vault.credential $passwordPath $password = Import-CliXml -Path $passwordPath # Get credentials Unlock-SecretStore -Password $password $clientid = Get-Secret -Name TamperProtection-ClientID -AsPlainText $clientsecret = Get-Secret -Name TamperProtection-Secret -AsPlainText #endregion Get-Content -path $servers #region Authenticate to Sophos Central and get metadata try { $response = Connect-SophosCentral -clientid $clientid -clientsecret $clientsecret -ErrorAction stop $token = $response.access_token } catch { throw \"connection error\" } #try/catch $metadata = Get-SophosCentralContext -token $token $TenantId = $metadata.TenantId $dataregion = $metadata.dataRegion #endregion # Get hash table with device ID's $computerHashTable = Get-EndpointIDHashTable # Test whether the CSV file exists; if it does, exclude the servers already scanned if (Test-Path -Path $CsvFile) { $csvData = Import-Csv -Path $CsvFile | Select-Object -ExpandProperty PSComputerName -Unique $servers = $servers | Where-Object { $_ -notin $csvData } } [System.Collections.Generic.List[PSObject]] $Sessions = @() # Connect to each server and add the session to the $Sessions array list foreach ($s in $servers) { $id = $computerHashTable[$s] if ($null -ne $id) { #region Disable Tamper Protection Write-output \"Disabling Tamper protection for [$s] - Device ID: [$id]\" Set-TamperProtection -dataregion $dataregion -tenantID $TenantId -token $token -enable:$false -id $id #endregion $PSSession = @{ ComputerName = $s } try { $session = New-PSSession @PSSession -ErrorAction Stop $Sessions.Add($session) } catch { # Add any errors to the connection error CSV file [pscustomobject]@{ ComputerName = $s Date = Get-Date ErrorMsg = $_ } | Export-Csv -Path $ConnectionErrors -Append } #try/catch } else { Write-Output \"Device ID not found for [$s]\" # Output empty object with just the Computername into the results $obj = [PSCustomObject]@{ ComputerName = $s SophosStatus = \"Not found\" ExitCode = \"\" PSComputerName = \"\" RunspaceId = \"\" PSShowComputerName = \"\" } $obj | Export-Csv -Path $CsvFile -Append } #if/else } #foreach $s # Execute the script on all remote sessions at once $Command = @{ Session = $Sessions FilePath = $ScriptFile } $Results = Invoke-Command @Command # Export the results to CSV $Results | Export-Csv -Path $CsvFile -Append # Close and remove the remote sessions Remove-PSSession -Session $Sessions Stop-Transcript üßº ‚ÄúThe Cleanup Crew: Uninstall Script‚Äù The uninstall script is designed to cleanly remove Sophos components before the Defender rollout. It checks for the presence of Sophos, attempts to uninstall it, and handles tamper protection gracefully. It also has a timer in place to ensure that the process does not hang indefinitely and keeps trying to uninstall within a 90-second window.\nIf tamper protection is still active, it will log the status and exit without disrupting the user. It will restart once the uninstall process is complete and there is no user logged in.\n\u003c# .SYNOPSIS Uninstall the Sophos Suite .DESCRIPTION This script is intended to be run on the client workstation. It would be executed by the control script which would create a session to each workstation .NOTES For Core Agent 2022.3 and later, run: C:\\Program Files\\Sophos\\Sophos Endpoint Agent\\uninstallgui.exe --quiet. For Windows 10 (x64) and Windows Server 2016 and later running Core Agent 2022.4 and later, run: C:\\Program Files\\Sophos\\Sophos Endpoint Agent\\SophosUninstall.exe --quiet. #\u003e [CmdletBinding()] param ( # PUT PARAMETER DEFINITIONS HERE AND DELETE THIS COMMENT. ) #region verbose Write-Verbose \"[BEGIN ] Starting: $($MyInvocation.Mycommand)\" Write-Verbose \"Execution Metadata:\" Write-Verbose \"User = $($env:userdomain)\\$($env:USERNAME)\" $id = [System.Security.Principal.WindowsIdentity]::GetCurrent() $IsAdmin = [System.Security.Principal.WindowsPrincipal]::new($id).IsInRole('administrators') Write-Verbose \"Is Admin = $IsAdmin\" Write-Verbose \"Computername = $env:COMPUTERNAME\" Write-Verbose \"OS = $((Get-CimInstance Win32_Operatingsystem).Caption)\" Write-Verbose \"Host = $($host.Name)\" Write-Verbose \"PSVersion = $($PSVersionTable.PSVersion)\" Write-Verbose \"Runtime = $(Get-Date)\" #endregion #region Information Write-Information \"Command = $($myinvocation.mycommand)\" -Tags Meta Write-Information \"PSVersion = $($PSVersionTable.PSVersion)\" -Tags Meta Write-Information \"User = $env:userdomain\\$env:username\" -tags Meta Write-Information \"Computer = $env:computername\" -tags Meta Write-Information \"PSHost = $($host.name)\" -Tags Meta Write-Information \"Test Date = $(Get-Date)\" -tags Meta #endregion #region code $myObject = [PSCustomObject]@{ ComputerName = $env:COMPUTERNAME SophosStatus = \"\" ExitCode = \"\" } try { if (Test-Path -Path \"HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Sophos Endpoint Agent\") { #region Uninstall # Get the Uninstall string $UninstallString = Get-ItemProperty \"HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Sophos Endpoint Agent\" -Name UninstallString | Select-Object -ExpandProperty UninstallString # start timer to allow tamper protection to take effect $timer = [system.diagnostics.stopwatch]::StartNew() # Keep trying if exitcode is 5 which means status is still active do { Write-Verbose \"Uninstall using [$UninstallString]\" $Process = Start-Process -FilePath $UninstallString -ArgumentList \"--quiet\" -PassThru -Wait $exitCode = $Process.ExitCode Write-Verbose \"Exit code: [$exitCode]\" # Pause if not successfull if ($exitCode -ne 1) { Write-Verbose \"Waiting 5 Seconds\" Start-Sleep -Seconds 5 } Write-Verbose \"Timer: [$($timer.Elapsed.TotalSeconds)]\" } while ($timer.Elapsed.TotalSeconds -lt 90 -and $exitCode -eq 5) #do/while $myObject.ExitCode = $exitCode # Decide what to do switch ($exitcode) { 1 { $action = \"Restart\" } # Uninstallation was successful but a reboot is required. 2 { $myObject.SophosStatus = \"Uninstall Failed\" } 5 { $myObject.SophosStatus = \"Uninstallation failed because tamper protection is active\" } 8 { $myObject.SophosStatus = \"UNINSTALL PENDING REBOOT\" $action = \"Restart\" } } #Switch #endregion #region Restart if ($action -eq \"Restart\") { $user = Get-CimInstance -Class Win32_ComputerSystem | Select-Object -ExpandProperty Username -ErrorAction stop if (-not ($user)) { $myObject.SophosStatus = \"Uninstalled\" Restart-Computer } else { $myObject.SophosStatus = \"Could not Restart, User logged in\" } } #if #endregion } else { $myObject.SophosStatus = \"Uninstalled\" } #if } catch { $myObject.SophosStatus = \"Error: [$($PSItem.Exception.Message)]\" } #try/catch # Output at the end $myObject #endregion ",
  "wordCount" : "1088",
  "inLanguage": "en",
  "datePublished": "2025-05-17T07:18:22+02:00",
  "dateModified": "2025-05-17T07:18:22+02:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://adrianmuscat.com/projects/endpoint-uninstall-automation/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Adrian Muscat",
    "logo": {
      "@type": "ImageObject",
      "url": "https://adrianmuscat.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://adrianmuscat.com/" accesskey="h" title="Adrian Muscat (Alt + H)">Adrian Muscat</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://adrianmuscat.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://adrianmuscat.com/about/" title="About Me">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://adrianmuscat.com/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://adrianmuscat.com/projects" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://adrianmuscat.com/skills" title="Skills">
                    <span>Skills</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      üõ†Ô∏è Automating Sophos Uninstall Across Hundreds of PCs‚ÄîWithout Disrupting Users
    </h1>
    <div class="post-meta"><span title='2025-05-17 07:18:22 +0200 CEST'>May 17, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>Migrating from Sophos to Defender for Endpoint came with a major challenge: tamper protection. To tackle it, I built a PowerShell module that interacts with the <a href="https://developer.sophos.com/docs/endpoint-v1/1/overview">Sophos Central API</a> to disable tamper protection remotely. You can check it out on <a href="https://github.com/adrimus/pssophoscentral">GitHub</a>.</p>
<h2 id="tldr">TL;DR<a hidden class="anchor" aria-hidden="true" href="#tldr">#</a></h2>
<p>This setup saved countless hours, avoided manual intervention, and kept users blissfully unaware‚Äîjust the way it should be. If you‚Äôre facing a similar migration, feel free to explore or fork the modules, I didn&rsquo;t get a chance to finish the module and did not include all the necessary components like paging as I didn&rsquo;t have to deal with more than 200 endpoints. Always happy to connect with others tackling endpoint automation!</p>
<h2 id="-the-orchestrator-control-script">üîß ‚ÄúThe Orchestrator: Control Script‚Äù<a hidden class="anchor" aria-hidden="true" href="#-the-orchestrator-control-script">#</a></h2>
<p>Then I created a control script that:</p>
<ul>
<li>üîì Disables tamper protection via the API</li>
<li>üßπ Runs the uninstall script on the target PC</li>
<li>üìÅ Logs results to a file so each PC is only processed once</li>
<li>üïí Runs after hours and checks that no user is signed in‚Äîensuring zero disruption</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Start-Transcript -Path c:\transcript.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Array of servers to connect to</span>
</span></span><span style="display:flex;"><span>    $servers = <span style="color:#e6db74">&#39;C:\POWERSHELL2\MDM\server.txt&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Specifies the path to save the results. If the script is interrupted and rerun, it will skip servers that have already been processed.</span>
</span></span><span style="display:flex;"><span>    $CsvFile = <span style="color:#e6db74">&#39;~\Results.csv&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The script file which is executed remotely on computer</span>
</span></span><span style="display:flex;"><span>    $ScriptFile = <span style="color:#e6db74">&#39;.\Uninstall-Sohpos.ps1&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Another CSV file to record connection errors</span>
</span></span><span style="display:flex;"><span>    $ConnectionErrors = <span style="color:#e6db74">&#39;~\Errors.csv&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Import-Module PSSophosCentral -Force
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#region API credentials</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get password for vault</span>
</span></span><span style="display:flex;"><span>$passwordPath = Join-Path (Split-Path $profile) SecretStore.vault.credential
</span></span><span style="display:flex;"><span>$passwordPath
</span></span><span style="display:flex;"><span>$password = Import-CliXml -Path $passwordPath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get credentials</span>
</span></span><span style="display:flex;"><span>Unlock-SecretStore -Password $password
</span></span><span style="display:flex;"><span>$clientid = Get-Secret -Name TamperProtection-ClientID -AsPlainText
</span></span><span style="display:flex;"><span>$clientsecret = Get-Secret -Name TamperProtection-Secret -AsPlainText
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Content -path $servers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#region Authenticate to Sophos Central and get metadata</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $response = Connect-SophosCentral -clientid $clientid -clientsecret $clientsecret -ErrorAction stop
</span></span><span style="display:flex;"><span>    $token = $response.access_token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#e6db74">&#34;connection error&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>} <span style="color:#75715e">#try/catch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$metadata = Get-SophosCentralContext -token $token
</span></span><span style="display:flex;"><span>$TenantId = $metadata.TenantId
</span></span><span style="display:flex;"><span>$dataregion = $metadata.dataRegion
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get hash table with device ID&#39;s</span>
</span></span><span style="display:flex;"><span>$computerHashTable = Get-EndpointIDHashTable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Test whether the CSV file exists; if it does, exclude the servers already scanned</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (Test-Path -Path $CsvFile) {
</span></span><span style="display:flex;"><span>    $csvData = Import-Csv -Path $CsvFile | 
</span></span><span style="display:flex;"><span>    Select-Object -ExpandProperty PSComputerName -Unique
</span></span><span style="display:flex;"><span>    $servers = $servers | Where-Object { $_ -notin $csvData }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">System.Collections.Generic.List[PSObject]</span>] $Sessions = @()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Connect to each server and add the session to the $Sessions array list</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($s <span style="color:#66d9ef">in</span> $servers) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $id = $computerHashTable[$s]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($null <span style="color:#f92672">-ne</span> $id) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region Disable Tamper Protection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Write-output <span style="color:#e6db74">&#34;Disabling Tamper protection for [</span>$s<span style="color:#e6db74">] - Device ID: [</span>$id<span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>        Set-TamperProtection -dataregion $dataregion -tenantID $TenantId -token $token -enable:$false -id $id 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $PSSession = @{
</span></span><span style="display:flex;"><span>            ComputerName = $s
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            $session = New-PSSession @PSSession -ErrorAction Stop
</span></span><span style="display:flex;"><span>            $Sessions.Add($session) 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Add any errors to the connection error CSV file</span>
</span></span><span style="display:flex;"><span>            [<span style="color:#66d9ef">pscustomobject</span>]@{
</span></span><span style="display:flex;"><span>                ComputerName = $s
</span></span><span style="display:flex;"><span>                Date         = Get-Date
</span></span><span style="display:flex;"><span>                ErrorMsg     = $_
</span></span><span style="display:flex;"><span>            } | Export-Csv -Path $ConnectionErrors -Append
</span></span><span style="display:flex;"><span>        } <span style="color:#75715e">#try/catch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        Write-Output <span style="color:#e6db74">&#34;Device ID not found for [</span>$s<span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Output empty object with just the Computername into the results</span>
</span></span><span style="display:flex;"><span>        $obj = [<span style="color:#66d9ef">PSCustomObject</span>]@{
</span></span><span style="display:flex;"><span>            ComputerName       = $s
</span></span><span style="display:flex;"><span>            SophosStatus       = <span style="color:#e6db74">&#34;Not found&#34;</span>
</span></span><span style="display:flex;"><span>            ExitCode           = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            PSComputerName     = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            RunspaceId         = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            PSShowComputerName = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>        $obj | Export-Csv -Path $CsvFile -Append
</span></span><span style="display:flex;"><span>    } <span style="color:#75715e">#if/else</span>
</span></span><span style="display:flex;"><span>} <span style="color:#75715e">#foreach $s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Execute the script on all remote sessions at once</span>
</span></span><span style="display:flex;"><span>$Command = @{
</span></span><span style="display:flex;"><span>    Session  = $Sessions
</span></span><span style="display:flex;"><span>    FilePath = $ScriptFile
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$Results = Invoke-Command @Command
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Export the results to CSV</span>
</span></span><span style="display:flex;"><span>$Results | Export-Csv -Path $CsvFile -Append
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Close and remove the remote sessions</span>
</span></span><span style="display:flex;"><span>Remove-PSSession -Session $Sessions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Stop-Transcript
</span></span></code></pre></div><h2 id="-the-cleanup-crew-uninstall-script">üßº ‚ÄúThe Cleanup Crew: Uninstall Script‚Äù<a hidden class="anchor" aria-hidden="true" href="#-the-cleanup-crew-uninstall-script">#</a></h2>
<p>The uninstall script is designed to cleanly remove Sophos components before the Defender rollout. It checks for the presence of Sophos, attempts to uninstall it, and handles tamper protection gracefully. It also has a timer in place to ensure that the process does not hang indefinitely and keeps trying to uninstall within a 90-second window.</p>
<p>If tamper protection is still active, it will log the status and exit without disrupting the user. It will restart once the uninstall process is complete and there is no user logged in.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">&lt;#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">.</span><span style="color:#e6db74">SYNOPSIS</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Uninstall the Sophos Suite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">.</span><span style="color:#e6db74">DESCRIPTION</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">This script is intended to be run on the client workstation. It would be executed by the control script which would create a session to each workstation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">.</span><span style="color:#e6db74">NOTES</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">For Core Agent 2022.3 and later, run:     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">C:\Program Files\Sophos\Sophos Endpoint Agent\uninstallgui.exe --quiet. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">For Windows 10 (x64) and Windows Server 2016 and later running Core Agent 2022.4 and later, run:      
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">C:\Program Files\Sophos\Sophos Endpoint Agent\SophosUninstall.exe --quiet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt;</span>
</span></span><span style="display:flex;"><span>[CmdletBinding()]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># PUT PARAMETER DEFINITIONS HERE AND DELETE THIS COMMENT.</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#region verbose</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;[BEGIN ] Starting: </span>$($MyInvocation.Mycommand)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;Execution Metadata:&#34;</span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;User = </span>$($env:userdomain)<span style="color:#e6db74">\</span>$($env:USERNAME)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$id = [<span style="color:#66d9ef">System.Security.Principal.WindowsIdentity</span>]::GetCurrent()
</span></span><span style="display:flex;"><span>$IsAdmin = [<span style="color:#66d9ef">System.Security.Principal.WindowsPrincipal</span>]::new($id).IsInRole(<span style="color:#e6db74">&#39;administrators&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;Is Admin = </span>$IsAdmin<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;Computername = </span>$env:COMPUTERNAME<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;OS = </span>$((Get-CimInstance Win32_Operatingsystem).Caption)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;Host = </span>$($host.Name)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;PSVersion = </span>$($PSVersionTable.PSVersion)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Verbose <span style="color:#e6db74">&#34;Runtime = </span>$(Get-Date)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#region Information</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Write-Information <span style="color:#e6db74">&#34;Command = </span>$($myinvocation.mycommand)<span style="color:#e6db74">&#34;</span> -Tags Meta
</span></span><span style="display:flex;"><span>Write-Information <span style="color:#e6db74">&#34;PSVersion = </span>$($PSVersionTable.PSVersion)<span style="color:#e6db74">&#34;</span> -Tags Meta
</span></span><span style="display:flex;"><span>Write-Information <span style="color:#e6db74">&#34;User = </span>$env:userdomain<span style="color:#e6db74">\</span>$env:username<span style="color:#e6db74">&#34;</span> -tags Meta
</span></span><span style="display:flex;"><span>Write-Information <span style="color:#e6db74">&#34;Computer = </span>$env:computername<span style="color:#e6db74">&#34;</span> -tags Meta
</span></span><span style="display:flex;"><span>Write-Information <span style="color:#e6db74">&#34;PSHost = </span>$($host.name)<span style="color:#e6db74">&#34;</span> -Tags Meta
</span></span><span style="display:flex;"><span>Write-Information <span style="color:#e6db74">&#34;Test Date = </span>$(Get-Date)<span style="color:#e6db74">&#34;</span> -tags Meta
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#region code</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$myObject = [<span style="color:#66d9ef">PSCustomObject</span>]@{
</span></span><span style="display:flex;"><span>    ComputerName = $env:COMPUTERNAME
</span></span><span style="display:flex;"><span>    SophosStatus = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ExitCode     = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (Test-Path -Path <span style="color:#e6db74">&#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\Sophos Endpoint Agent&#34;</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region Uninstall </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get the Uninstall string</span>
</span></span><span style="display:flex;"><span>        $UninstallString = Get-ItemProperty <span style="color:#e6db74">&#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\Sophos Endpoint Agent&#34;</span> -Name UninstallString | 
</span></span><span style="display:flex;"><span>        Select-Object -ExpandProperty UninstallString
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># start timer to allow tamper protection to take effect  </span>
</span></span><span style="display:flex;"><span>        $timer = [<span style="color:#66d9ef">system.diagnostics.stopwatch</span>]::StartNew()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keep trying if exitcode is 5 which means status is still active</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>            Write-Verbose <span style="color:#e6db74">&#34;Uninstall using [</span>$UninstallString<span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>            $Process = Start-Process -FilePath $UninstallString -ArgumentList <span style="color:#e6db74">&#34;--quiet&#34;</span> -PassThru -Wait
</span></span><span style="display:flex;"><span>            $exitCode = $Process.ExitCode
</span></span><span style="display:flex;"><span>            Write-Verbose <span style="color:#e6db74">&#34;Exit code: [</span>$exitCode<span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Pause if not successfull</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($exitCode <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>                Write-Verbose <span style="color:#e6db74">&#34;Waiting 5 Seconds&#34;</span>
</span></span><span style="display:flex;"><span>                Start-Sleep -Seconds <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Write-Verbose <span style="color:#e6db74">&#34;Timer: [</span>$($timer.Elapsed.TotalSeconds)<span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">while</span> ($timer.Elapsed.TotalSeconds <span style="color:#f92672">-lt</span> <span style="color:#ae81ff">90</span> <span style="color:#f92672">-and</span> $exitCode <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">5</span>) <span style="color:#75715e">#do/while</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $myObject.ExitCode = $exitCode
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decide what to do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> ($exitcode) {
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span> { $action = <span style="color:#e6db74">&#34;Restart&#34;</span> } <span style="color:#75715e"># Uninstallation was successful but a reboot is required.  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">2</span> { $myObject.SophosStatus = <span style="color:#e6db74">&#34;Uninstall Failed&#34;</span> }
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">5</span> { $myObject.SophosStatus = <span style="color:#e6db74">&#34;Uninstallation failed because tamper protection is active&#34;</span> }
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">8</span> { 
</span></span><span style="display:flex;"><span>                $myObject.SophosStatus = <span style="color:#e6db74">&#34;UNINSTALL PENDING REBOOT&#34;</span>
</span></span><span style="display:flex;"><span>                $action = <span style="color:#e6db74">&#34;Restart&#34;</span> 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#75715e">#Switch</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region Restart</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($action <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;Restart&#34;</span>) {
</span></span><span style="display:flex;"><span>            $user = Get-CimInstance -Class Win32_ComputerSystem | Select-Object -ExpandProperty Username -ErrorAction stop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">-not</span> ($user)) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                $myObject.SophosStatus = <span style="color:#e6db74">&#34;Uninstalled&#34;</span>
</span></span><span style="display:flex;"><span>                Restart-Computer
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                $myObject.SophosStatus = <span style="color:#e6db74">&#34;Could not Restart, User logged in&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#75715e">#if</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $myObject.SophosStatus = <span style="color:#e6db74">&#34;Uninstalled&#34;</span> 
</span></span><span style="display:flex;"><span>    } <span style="color:#75715e">#if</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $myObject.SophosStatus = <span style="color:#e6db74">&#34;Error: [</span>$($PSItem.Exception.Message)<span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>} <span style="color:#75715e">#try/catch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output at the end</span>
</span></span><span style="display:flex;"><span>$myObject
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endregion</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://adrianmuscat.com/">Adrian Muscat</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
